// Prisma schema for WAGO Project Hub (single source of truth)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ACCOUNTS (B2B hierarchy: Manufacturer → Distributors / Direct → Customers)
// ============================================================================

enum AccountType {
  MANUFACTURER  // Internal (Admin/RSM)
  DISTRIBUTOR   // Reseller organizations
  CUSTOMER      // Direct (RSM-served) or Basic (distributor-served)
}

model Account {
  id        String      @id @default(uuid())
  name      String
  type      AccountType
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  // Relations
  usersAsAccount    User[]              @relation("UserAccount")
  managedBy         AccountAssignment[] @relation("AccountAsManager")
  managedAsCustomer AccountAssignment[] @relation("AccountAsManaged")

  @@map("accounts")
}

// Direct vs Basic: manager_account_id = NULL → Direct (RSM-managed); else → Basic (distributor-managed)
model AccountAssignment {
  id                 String    @id @default(uuid())
  managerAccountId   String?   @map("manager_account_id")   // Distributor account; NULL for Direct
  managedAccountId   String    @unique @map("managed_account_id") // Customer account only
  rsmId              String    @map("rsm_id")
  assignedById       String?   @map("assigned_by_id")
  assignedAt         DateTime  @default(now()) @map("assigned_at")

  // Relations
  managerAccount     Account?  @relation("AccountAsManager", fields: [managerAccountId], references: [id], onDelete: SetNull)
  managedAccount     Account   @relation("AccountAsManaged", fields: [managedAccountId], references: [id], onDelete: Cascade)
  rsm                User      @relation("AccountAssignmentRsm", fields: [rsmId], references: [id], onDelete: Cascade)
  assignedBy         User?     @relation("AccountAssignmentAssignedBy", fields: [assignedById], references: [id], onDelete: SetNull)

  @@index([managerAccountId])
  @@index([rsmId])
  @@map("account_assignments")
}

// ============================================================================
// AUTHENTICATION & USERS
// ============================================================================

enum UserRole {
  FREE             // No login - BOM Cross, Product Finder only
  BASIC            // @deprecated use BASIC_USER
  TURNKEY          // @deprecated use DIRECT_USER
  DISTRIBUTOR      // @deprecated use DISTRIBUTOR_REP
  RSM              // Regional Sales Manager - Direct + Distributors
  ADMIN            // Full access
  DISTRIBUTOR_REP  // Reseller org; manages Basic accounts
  DIRECT_USER      // Customer buying direct from manufacturer (RSM-served)
  BASIC_USER       // Customer buying through distributor
}

model User {
  id              String    @id @default(uuid())
  email           String?   @unique // Nullable for FREE users (anonymous sessions)
  passwordHash    String?   @map("password_hash") // Nullable for FREE users
  firstName       String?   @map("first_name")
  lastName        String?   @map("last_name")
  companyName     String?   @map("company_name")
  role            UserRole  @default(FREE)
  catalogId       String?   @map("catalog_id")
  isActive        Boolean   @default(true) @map("is_active")
  
  // Account (company) – required for DISTRIBUTOR_REP, DIRECT_USER, BASIC_USER
  accountId       String?   @map("account_id")
  
  // Hierarchical relationships (legacy; hierarchy can use AccountAssignment)
  assignedToDistributorId String? @map("assigned_to_distributor_id") // Basic/Direct assigned to Distributor
  assignedToRsmId         String? @map("assigned_to_rsm_id") // Distributor assigned to RSM
  
  // TurnKey Team (deprecated – no longer used in app)
  turnkeyTeamId   String?   @map("turnkey_team_id")
  
  // Distributor settings
  distributorMarginPercent Float? @map("distributor_margin_percent")
  
  // Session tracking for FREE users
  sessionId       String?   @unique @map("session_id")
  lastActiveAt    DateTime? @map("last_active_at")
  
  // Profile (optional)
  avatarUrl       String?   @map("avatar_url")
  logoUrl         String?   @map("logo_url")   // Company logo for Pricing Proposal header (RSM / Distributor)
  accentColor     String?   @map("accent_color") // Hex color for branded PDF (e.g. "#059669"). RSM/Distributor only.
  address         String?   @db.Text
  phone           String?
  defaultTerms    String?   @map("default_terms") @db.Text // Default Terms text for Pricing Proposal PDF (RSM/Distributor)
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  account         Account?  @relation("UserAccount", fields: [accountId], references: [id], onDelete: SetNull)
  catalog         Catalog?  @relation(fields: [catalogId], references: [id])
  turnkeyTeam     TurnkeyTeam? @relation(fields: [turnkeyTeamId], references: [id])
  
  // Hierarchical relations
  assignedToDistributor User? @relation("DistributorAssignments", fields: [assignedToDistributorId], references: [id])
  managedUsers          User[] @relation("DistributorAssignments")
  
  assignedToRsm         User? @relation("RsmAssignments", fields: [assignedToRsmId], references: [id])
  managedByRsm          User[] @relation("RsmAssignments")
  
  accountAssignmentsAsRsm AccountAssignment[] @relation("AccountAssignmentRsm")
  accountAssignmentsAssignedBy AccountAssignment[] @relation("AccountAssignmentAssignedBy")
  
  // Content relations
  customersCreated Customer[] @relation("CustomerCreator")
  videoViews      UserVideoView[]
  comments        Comment[]
  videosUploaded  Video[]   @relation("VideoUploader")
  videosApproved  Video[]   @relation("VideoApprover")
  projects        Project[]
  quotes          Quote[]
  costTables      CostTable[]
  catalogsCreated Catalog[] @relation("CatalogCreator")
  catalogAssignments CatalogAssignment[]
  priceContractAssignments UserPriceContractAssignment[]
  priceContractsCreated    PriceContract[]
  priceContractAssignmentsGiven UserPriceContractAssignment[] @relation("PriceContractAssigner")
  priceChanges    PriceHistory[] @relation("PriceChanges")
  salesCustomers  SalesCustomer[] @relation("SalesCustomerRsm")
  literatureUploaded Literature[] @relation("LiteratureUploader")
  literatureKits     LiteratureKit[]
  crossReferencesCreated CrossReference[] @relation("CrossReferenceCreator")
  videoFavorites     VideoFavorite[]
  videoPlaylists     VideoPlaylist[]

  @@map("users")
}

// ============================================================================
// TURNKEY TEAMS (deprecated – no longer used in app; tables kept for DB compatibility)
// ============================================================================

model TurnkeyTeam {
  id          String    @id @default(uuid())
  name        String
  description String?
  createdById String    @map("created_by_id")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  members     User[]
  costTables  CostTable[]

  @@map("turnkey_teams")
}

// ============================================================================
// COST TABLES (for TurnKey users)
// ============================================================================

model CostTable {
  id              String    @id @default(uuid())
  name            String
  description     String?
  userId          String?   @map("user_id") // Individual TurnKey user
  turnkeyTeamId   String?   @map("turnkey_team_id") // Or shared by team
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  user            User?     @relation(fields: [userId], references: [id])
  turnkeyTeam     TurnkeyTeam? @relation(fields: [turnkeyTeamId], references: [id])
  items           CostTableItem[]

  @@map("cost_tables")
}

model CostTableItem {
  id          String    @id @default(uuid())
  costTableId String    @map("cost_table_id")
  partNumber  String    @map("part_number")
  description String?
  customCost  Float     @map("custom_cost")
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  costTable   CostTable @relation(fields: [costTableId], references: [id], onDelete: Cascade)

  @@unique([costTableId, partNumber])
  @@map("cost_table_items")
}

// ============================================================================
// CATALOG ASSIGNMENTS (Distributors assign catalogs to users)
// ============================================================================

model CatalogAssignment {
  id           String    @id @default(uuid())
  catalogId    String    @map("catalog_id")
  userId       String    @map("user_id")
  isPrimary    Boolean   @default(false) @map("is_primary") // Exactly one primary per user
  assignedById String   @map("assigned_by_id")
  assignedAt   DateTime  @default(now()) @map("assigned_at")

  // Relations
  catalog      Catalog   @relation(fields: [catalogId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([catalogId, userId])
  @@index([userId])
  @@map("catalog_assignments")
}

// ============================================================================
// CATALOGS & CATEGORIES
// ============================================================================

model Catalog {
  id               String    @id @default(uuid())
  name             String
  description      String?
  isActive         Boolean   @default(true) @map("is_active")
  isPublic         Boolean   @default(false) @map("is_public")
  isMaster         Boolean   @default(false) @map("is_master") // Label: single source of truth (ADMIN)
  sourceCatalogId  String?   @map("source_catalog_id") // Catalog this was built from (MASTER or secondary)
  createdById     String?   @map("created_by_id")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  users            User[]
  createdBy        User?     @relation("CatalogCreator", fields: [createdById], references: [id])
  sourceCatalog   Catalog?  @relation("CatalogSource", fields: [sourceCatalogId], references: [id], onDelete: SetNull)
  derivedCatalogs Catalog[]  @relation("CatalogSource")
  categories      Category[]
  parts           Part[]
  assignments     CatalogAssignment[]
  catalogItems    CatalogItem[] // User-selected products for this catalog
  projects        Project[]

  @@map("catalogs")
}

// ============================================================================
// CATALOG ITEMS (User-selected products in custom catalogs)
// ============================================================================

model CatalogItem {
  id          String    @id @default(uuid())
  catalogId   String    @map("catalog_id")
  productId   String?   @map("product_id") // Selected product
  categoryId  String?   @map("category_id") // Or entire category selected
  addedAt     DateTime  @default(now()) @map("added_at")

  // Relations
  catalog     Catalog   @relation(fields: [catalogId], references: [id], onDelete: Cascade)
  product     Part?     @relation(fields: [productId], references: [id], onDelete: Cascade)
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([catalogId])
  @@index([productId])
  @@index([categoryId])
  @@map("catalog_items")
}

model Category {
  id            String    @id @default(uuid())
  catalogId     String    @map("catalog_id")
  parentId      String?   @map("parent_id")
  name          String
  shortText     String?   @map("short_text") @db.VarChar(100)
  longText      String?   @map("long_text") @db.Text
  thumbnailUrl  String?   @map("thumbnail_url")
  order         Int       @default(0)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  catalog       Catalog   @relation(fields: [catalogId], references: [id], onDelete: Cascade)
  parent        Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children      Category[] @relation("CategoryHierarchy")
  parts         Part[]
  catalogItems  CatalogItem[] // Categories selected in user catalogs
  priceContractItems PriceContractItem[]

  @@index([catalogId])
  @@index([parentId])
  @@index([order])
  @@map("categories")
}

// ============================================================================
// PARTS & PRODUCTS
// ============================================================================

model Part {
  id                  String    @id @default(uuid())
  catalogId           String    @map("catalog_id")
  categoryId          String    @map("category_id")
  partNumber          String    @map("part_number")
  series              String?   // Product series/family
  description         String    @db.Text
  englishDescription  String?   @map("english_description") @db.Text
  thumbnailUrl        String?   @map("thumbnail_url")
  minQty              Int       @default(1) @map("min_qty")
  packageQty          Int       @default(1) @map("package_qty")
  level               Int       @default(1) // Video progression level
  basePrice           Float?    @map("base_price") // List price (each)
  listPricePer100     Float?    @map("list_price_per_100") // List price per 100 units
  wagoIdent           String?   @map("wago_ident") // WAGO internal identifier
  distributorDiscount Float     @default(0) @map("distributor_discount") // Discount percentage
  active              Boolean   @default(true) // Active/inactive flag
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  catalog       Catalog   @relation(fields: [catalogId], references: [id], onDelete: Cascade)
  category      Category  @relation(fields: [categoryId], references: [id])
  videos        Video[]
  files         PartFile[]
  quoteItems    QuoteItem[]
  projectItems  ProjectItem[]
  wagoEquivalents CrossReference[] @relation("WagoPart")
  priceHistory  PriceHistory[]
  catalogItems  CatalogItem[]
  priceContractItems PriceContractItem[]
  literature     LiteraturePart[]
  videoLibrary   VideoLibraryPart[]

  @@unique([catalogId, partNumber])
  @@index([catalogId])
  @@index([categoryId])
  @@index([partNumber])
  @@index([series])
  @@index([active])
  @@map("parts")
}

// ============================================================================
// PRICE HISTORY (for tracking price changes during imports)
// ============================================================================

model PriceHistory {
  id          String    @id @default(uuid())
  partId      String    @map("part_id")
  partNumber  String    @map("part_number")
  oldPrice    Float     @map("old_price")
  newPrice    Float     @map("new_price")
  changedById String    @map("changed_by_id")
  changedAt   DateTime  @default(now()) @map("changed_at")
  importBatch String?   @map("import_batch") // Groups changes from same import

  // Relations
  part        Part      @relation(fields: [partId], references: [id], onDelete: Cascade)
  changedBy   User      @relation("PriceChanges", fields: [changedById], references: [id])

  @@index([partId])
  @@index([partNumber])
  @@index([importBatch])
  @@index([changedAt])
  @@map("price_history")
}

model PartFile {
  id          String    @id @default(uuid())
  partId      String    @map("part_id")
  fileType    String    @map("file_type") // datasheet, cad, brochure, image
  fileName    String    @map("file_name")
  fileUrl     String    @map("file_url")
  fileSize    Int?      @map("file_size")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  part        Part      @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@index([partId])
  @@map("part_files")
}

// ============================================================================
// LITERATURE LIBRARY
// ============================================================================

enum LiteratureType {
  WHITE_PAPER
  FLYER
  BROCHURE
  CATALOG_PAGE
}

model Literature {
  id           String         @id @default(uuid())
  title        String
  description  String?        @db.Text
  type         LiteratureType
  filePath     String         @map("file_path")
  fileSize     Int            @map("file_size") // bytes
  keywords     String[]       // searchable tags e.g. "CAGE CLAMP", "push-in terminal"
  industryTags String[]       @map("industry_tags") // e.g. "Automation", "Panel Building"
  uploadedById String         @map("uploaded_by_id")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  uploadedBy      User                @relation("LiteratureUploader", fields: [uploadedById], references: [id], onDelete: Cascade)
  quoteLiterature QuoteLiterature[]
  parts           LiteraturePart[]
  series          LiteratureSeries[]
  kitItems        LiteratureKitItem[]

  @@index([type])
  @@map("literature")
}

model LiteraturePart {
  literatureId String   @map("literature_id")
  partId       String   @map("part_id")
  assignedAt   DateTime @default(now()) @map("assigned_at")

  literature   Literature @relation(fields: [literatureId], references: [id], onDelete: Cascade)
  part         Part       @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@id([literatureId, partId])
  @@index([literatureId])
  @@index([partId])
  @@map("literature_parts")
}

model LiteratureSeries {
  literatureId String   @map("literature_id")
  seriesName   String   @map("series_name")
  assignedAt   DateTime @default(now()) @map("assigned_at")

  literature   Literature @relation(fields: [literatureId], references: [id], onDelete: Cascade)

  @@id([literatureId, seriesName])
  @@index([literatureId])
  @@index([seriesName])
  @@map("literature_series")
}

model QuoteLiterature {
  quoteId      String   @map("quote_id")
  literatureId String   @map("literature_id")
  attachedAt   DateTime @default(now()) @map("attached_at")

  quote      Quote      @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  literature Literature @relation(fields: [literatureId], references: [id], onDelete: Cascade)

  @@id([quoteId, literatureId])
  @@index([quoteId])
  @@index([literatureId])
  @@map("quote_literature")
}

model LiteratureKit {
  id        String              @id @default(uuid())
  name      String
  notes     String?             @db.Text
  userId    String              @map("user_id")
  createdAt DateTime            @default(now()) @map("created_at")
  updatedAt DateTime            @updatedAt @map("updated_at")

  user  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  items LiteratureKitItem[]

  @@index([userId])
  @@map("literature_kits")
}

model LiteratureKitItem {
  kitId        String   @map("kit_id")
  literatureId String   @map("literature_id")
  addedAt      DateTime @default(now()) @map("added_at")

  kit        LiteratureKit @relation(fields: [kitId], references: [id], onDelete: Cascade)
  literature Literature    @relation(fields: [literatureId], references: [id], onDelete: Cascade)

  @@id([kitId, literatureId])
  @@index([kitId])
  @@index([literatureId])
  @@map("literature_kit_items")
}

model Settings {
  id          Int     @id @default(autoincrement())
  key         String  @unique
  value       String  @db.Text
  description String? @db.Text

  @@map("settings")
}

// ============================================================================
// VIDEOS & ENGAGEMENT
// ============================================================================

enum VideoStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VideoType {
  TECHNICAL
  APPLICATION
  TESTIMONIAL
  TUTORIAL
  PRODUCT_DEMO
  WEBINAR
  TRAINING
  OTHER
}

model Video {
  id            String      @id @default(uuid())
  partId        String?     @map("part_id")
  videoUrl      String      @map("video_url")
  title         String
  description   String?     @db.Text
  duration      Int?        // Duration in seconds
  level         Int         @default(1) // 1, 2, or 3
  status        VideoStatus @default(PENDING)
  videoType     VideoType   @default(TECHNICAL) @map("video_type")
  keywords      String[]
  industryTags  String[]    @map("industry_tags")
  thumbnailUrl  String?     @map("thumbnail_url")
  uploadedById  String?     @map("uploaded_by_id")
  approvedById  String?     @map("approved_by_id")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  approvedAt    DateTime?   @map("approved_at")

  // Relations
  part          Part?       @relation(fields: [partId], references: [id], onDelete: SetNull)
  uploadedBy    User?       @relation("VideoUploader", fields: [uploadedById], references: [id])
  approvedBy    User?       @relation("VideoApprover", fields: [approvedById], references: [id])
  views         UserVideoView[]
  comments      Comment[]
  libraryParts  VideoLibraryPart[]
  librarySeries VideoLibrarySeries[]
  favorites     VideoFavorite[]
  playlistItems VideoPlaylistItem[]

  @@index([partId])
  @@index([status])
  @@index([level])
  @@index([videoType])
  @@map("videos")
}

model UserVideoView {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  videoId     String    @map("video_id")
  viewCount   Int       @default(0) @map("view_count")
  lastViewedAt DateTime @map("last_viewed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  video       Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@index([videoId])
  @@map("user_video_views")
}

model Comment {
  id          String    @id @default(uuid())
  videoId     String    @map("video_id")
  userId      String    @map("user_id")
  parentId    String?   @map("parent_id")
  content     String    @db.Text
  imageUrl    String?   @map("image_url")
  likesCount  Int       @default(0) @map("likes_count")
  isApproved  Boolean   @default(true) @map("is_approved")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  video       Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent      Comment?  @relation("CommentThread", fields: [parentId], references: [id])
  replies     Comment[] @relation("CommentThread")

  @@index([videoId])
  @@index([userId])
  @@index([parentId])
  @@map("comments")
}

model VideoLibraryPart {
  videoId    String   @map("video_id")
  partId     String   @map("part_id")
  assignedAt DateTime @default(now()) @map("assigned_at")

  video      Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  part       Part     @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@id([videoId, partId])
  @@index([videoId])
  @@index([partId])
  @@map("video_library_parts")
}

model VideoLibrarySeries {
  videoId    String   @map("video_id")
  seriesName String   @map("series_name")
  assignedAt DateTime @default(now()) @map("assigned_at")

  video      Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@id([videoId, seriesName])
  @@index([videoId])
  @@index([seriesName])
  @@map("video_library_series")
}

model VideoFavorite {
  userId    String   @map("user_id")
  videoId   String   @map("video_id")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@id([userId, videoId])
  @@index([userId])
  @@index([videoId])
  @@map("video_favorites")
}

model VideoPlaylist {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  description String?  @db.Text
  isPublic    Boolean  @default(false) @map("is_public")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       VideoPlaylistItem[]

  @@index([userId])
  @@map("video_playlists")
}

model VideoPlaylistItem {
  id         String   @id @default(uuid())
  playlistId String   @map("playlist_id")
  videoId    String   @map("video_id")
  order      Int      @default(0)
  addedAt    DateTime @default(now()) @map("added_at")

  playlist   VideoPlaylist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  video      Video         @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([playlistId, videoId])
  @@index([playlistId])
  @@index([videoId])
  @@map("video_playlist_items")
}

// ============================================================================
// CUSTOMERS
// ============================================================================

model Customer {
  id        String    @id @default(uuid())
  name      String
  company   String?
  email     String?
  phone     String?
  address   String?   @db.Text
  city      String?
  state     String?
  zipCode   String?   @map("zip_code")
  createdById String  @map("created_by_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  createdBy User    @relation("CustomerCreator", fields: [createdById], references: [id])
  quotes    Quote[]

  @@index([createdById])
  @@map("customers")
}

// ============================================================================
// PRICING & QUOTES
// ============================================================================

model Quote {
  id              String    @id @default(uuid())
  quoteNumber     String    @unique @map("quote_number")
  catalogId       String    @map("catalog_id")
  priceContractId String?   @map("price_contract_id") // Optional: special pricing overlay used for this quote
  userId          String    @map("user_id")
  customerId      String?   @map("customer_id")
  customerName    String?   @map("customer_name")
  customerEmail   String?   @map("customer_email")
  customerCompany String?   @map("customer_company")
  notes           String?   @db.Text
  note            String?   @db.VarChar(150) // Legacy - use notes
  total           Float     @default(0)
  validUntil      DateTime? @map("valid_until")
  fob             String?   @db.VarChar(100)
  terms           String?   @default("Net 30") @db.Text // Default from quote owner's profile Terms (User.defaultTerms)
  isActive        Boolean   @default(true) @map("is_active")
  sentAt         DateTime? @map("sent_at") // First time quote was emailed (optional)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  user          User         @relation(fields: [userId], references: [id])
  customer      Customer?    @relation(fields: [customerId], references: [id])
  priceContract PriceContract? @relation(fields: [priceContractId], references: [id])
  items         QuoteItem[]
  discounts     QuoteDiscount[]
  literature    QuoteLiterature[]

  @@index([catalogId])
  @@index([userId])
  @@index([customerId])
  @@index([priceContractId])
  @@map("quotes")
}

model EmailLog {
  id        Int       @id @default(autoincrement())
  quoteId   String?   @map("quote_id") // Quote.id (uuid); soft reference for audit
  recipient String
  subject   String
  status    String    // 'sent' | 'failed' | 'bounced'
  error     String?   @db.Text
  sentAt    DateTime  @default(now()) @map("sent_at")
  resendId  String?   @unique @map("resend_id") // Resend email id for webhook lookup

  @@index([quoteId])
  @@map("email_logs")
}

model QuoteItem {
  id                      String    @id @default(uuid())
  quoteId                 String    @map("quote_id")
  partId                  String    @map("part_id")
  partNumber              String    @map("part_number")
  description             String
  quantity                Int       @default(1)
  packageQty              Int       @default(1) @map("package_qty")
  minQty                  Int       @map("min_qty")
  discountPct             Float     @default(0) @map("discount_pct")
  marginPct               Float     @default(0) @map("margin_pct")
  costPrice               Float     @map("cost_price")
  sellPrice               Float?    @map("sell_price")
  lineTotal               Float     @map("line_total")
  isCostAffected          Boolean   @default(false) @map("is_cost_affected")
  isSellAffected          Boolean   @default(false) @map("is_sell_affected")
  // Snapshot fields - frozen at quote creation
  snapshotSeries          String?   @map("snapshot_series")
  snapshotPartNumber      String?   @map("snapshot_part_number")
  snapshotPrice           Float?    @map("snapshot_price")
  snapshotMinQty          Int?      @map("snapshot_min_qty")
  snapshotDescription     String?   @map("snapshot_description") @db.Text
  snapshotDistributorDiscount Float? @map("snapshot_distributor_discount")
  createdAt               DateTime  @default(now()) @map("created_at")

  // Relations
  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  part  Part  @relation(fields: [partId], references: [id])

  @@index([quoteId])
  @@index([partId])
  @@map("quote_items")
}

model QuoteDiscount {
  id              String    @id @default(uuid())
  quoteId         String    @map("quote_id")
  discountType    String    @map("discount_type") // category, series, part
  targetValue     String    @map("target_value") // category name, series name, or part number
  discountPercent Float     @map("discount_percent")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  quote           Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@map("quote_discounts")
}

// ============================================================================
// PRICE CONTRACTS (Special pricing overlays – ADMIN/RSM only)
// ============================================================================

model PriceContract {
  id             String    @id @default(uuid())
  name           String
  description    String?   @db.Text
  quoteNumber    String?   @map("quote_number")
  quoteCore      String?   @map("quote_core")
  quoteYear      String?   @map("quote_year")
  quotePrefix    String?   @map("quote_prefix")
  quoteRevision  String?   @map("quote_revision")
  validFrom      DateTime? @map("valid_from")
  validTo        DateTime? @map("valid_to")
  createdById    String    @map("created_by_id")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  createdBy   User      @relation(fields: [createdById], references: [id])
  items       PriceContractItem[]
  userAssignments UserPriceContractAssignment[]
  quotes      Quote[]

  @@index([createdById])
  @@index([quoteCore, quoteYear])
  @@map("price_contracts")
}

model PriceContractItem {
  id                String    @id @default(uuid())
  contractId        String    @map("contract_id")
  partId            String?   @map("part_id") // Specific product (when Part exists in catalog)
  partNumber        String?   @map("part_number") // Raw part number from PDF/import when no matching Part
  categoryId        String?   @map("category_id") // For series discounts: matched category (by name/number)
  seriesOrGroup     String?   @map("series_or_group") // Series/group name (e.g. "209")
  costPrice         Float     @map("cost_price")
  suggestedSellPrice Float?   @map("suggested_sell_price") // Editable by assignees
  discountPercent   Float?    @map("discount_percent")
  moq               String?  @map("moq") // Display string e.g. "1", "1-99"
  minQuantity       Int       @default(1) @map("min_quantity")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  contract    PriceContract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  part        Part?         @relation(fields: [partId], references: [id], onDelete: SetNull)
  category    Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([contractId])
  @@index([partId])
  @@index([categoryId])
  @@index([seriesOrGroup])
  @@map("price_contract_items")
}

model UserPriceContractAssignment {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  contractId   String   @map("contract_id")
  assignedById String   @map("assigned_by_id")
  assignedAt   DateTime @default(now()) @map("assigned_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  contract     PriceContract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  assignedBy   User          @relation("PriceContractAssigner", fields: [assignedById], references: [id])

  @@unique([userId, contractId])
  @@index([userId])
  @@index([contractId])
  @@map("user_price_contract_assignments")
}

// ============================================================================
// PROJECTS & BOMs
// ============================================================================

enum ProjectStatus {
  DRAFT        // Building BOM, not yet submitted
  SUBMITTED    // Submitted for review
  PROCESSING   // Auto-classify / cross-reference in progress
  COMPLETED    // Report generated, final
}

model Project {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  catalogId       String?   @map("catalog_id") // Catalog to search for parts in this project
  name            String
  description     String?   @db.Text
  status          ProjectStatus @default(DRAFT)
  currentRevision Int       @default(1) @map("current_revision")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  catalog         Catalog?  @relation(fields: [catalogId], references: [id], onDelete: SetNull)
  items           ProjectItem[]
  revisions       ProjectRevision[]

  @@index([userId])
  @@index([catalogId])
  @@index([status])
  @@map("projects")
}

enum PanelAccessory {
  PANEL
  ACCESSORY
}

model ProjectItem {
  id                String    @id @default(uuid())
  projectId         String    @map("project_id")
  revisionNumber    Int       @map("revision_number")
  partId            String?   @map("part_id") // NULL if non-WAGO part
  manufacturer      String?
  partNumber        String    @map("part_number")
  description       String
  quantity          Int       @default(1)
  unitPrice         Float?    @map("unit_price")
  isWagoPart        Boolean   @default(false) @map("is_wago_part")
  hasWagoEquivalent Boolean   @default(false) @map("has_wago_equivalent")
  panelAccessory    PanelAccessory? @map("panel_accessory") // Panel vs Accessory for BOM classification
  notes             String?   @db.Text
  createdAt         DateTime  @default(now()) @map("created_at")

  // Relations
  project           Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  part              Part?     @relation(fields: [partId], references: [id])

  @@index([projectId])
  @@index([revisionNumber])
  @@map("project_items")
}

model ProjectRevision {
  id              String    @id @default(uuid())
  projectId       String    @map("project_id")
  revisionNumber  Int       @map("revision_number")
  changeSummary   String    @map("change_summary") @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, revisionNumber])
  @@index([projectId])
  @@map("project_revisions")
}

// ============================================================================
// NON-WAGO PRODUCT DATABASE (admin-maintained catalog of competitor parts)
// ============================================================================

model NonWagoProduct {
  id          String   @id @default(uuid())
  manufacturer String
  partNumber  String   @map("part_number")
  description String?  @db.Text
  category    String?  // Optional category for grouping
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([manufacturer, partNumber])
  @@index([manufacturer])
  @@index([partNumber])
  @@map("non_wago_products")
}

// ============================================================================
// CROSS-REFERENCES (maps non-WAGO manufacturer+partNumber to WAGO Part)
// ============================================================================

model CrossReference {
  id                    String    @id @default(uuid())
  originalManufacturer  String    @map("original_manufacturer")
  originalPartNumber    String    @map("original_part_number")
  wagoPartId            String    @map("wago_part_id")
  compatibilityScore    Float     @default(1.0) @map("compatibility_score") // 0.0 to 1.0
  notes                 String?   @db.Text
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // MASTER import extended columns (nullable for backward compatibility)
  partNumberA           String?   @map("part_number_a")
  partNumberB           String?   @map("part_number_b")
  manufactureName       String?   @map("manufacture_name")
  activeItem            Boolean?  @map("active_item")
  estimatedPrice        Decimal?  @map("estimated_price") @db.Decimal(12, 4)
  wagoCrossA            String?   @map("wago_cross_a")
  wagoCrossB            String?   @map("wago_cross_b")
  notesA                String?   @map("notes_a") @db.Text
  notesB                String?   @map("notes_b") @db.Text
  author                String?   @map("author")
  lastDateModified      DateTime? @map("last_date_modified")
  importBatchId         String?   @map("import_batch_id")
  createdById           String?   @map("created_by_id")
  sourceFilename        String?   @map("source_filename")

  // Relations (originalPart omitted - partNumber is not globally unique)
  wagoPart              Part      @relation("WagoPart", fields: [wagoPartId], references: [id], onDelete: Cascade)
  createdBy             User?     @relation("CrossReferenceCreator", fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([originalManufacturer, originalPartNumber, wagoPartId])
  @@index([originalManufacturer, originalPartNumber])
  @@index([wagoPartId])
  @@index([importBatchId])
  @@map("cross_references")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

model Notification {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  type        String    // video_approved, new_comment, etc.
  title       String
  message     String    @db.Text
  relatedId   String?   @map("related_id") // Video ID, Comment ID, etc.
  isRead      Boolean   @default(false) @map("is_read")
  sentEmail   Boolean   @default(false) @map("sent_email")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

// ============================================================================
// SALES DASHBOARD (RSM / Admin - uploaded from Excel)
// ============================================================================

model SalesCustomer {
  id     String       @id @default(cuid())
  code   String       // Customer code from upload
  name   String
  rsmId  String       @map("rsm_id") // RSM who owns this data
  rsm    User         @relation("SalesCustomerRsm", fields: [rsmId], references: [id], onDelete: Cascade)
  sales  MonthlySale[]

  @@unique([rsmId, code])
  @@index([rsmId])
  @@map("sales_customers")
}

model MonthlySale {
  id                String       @id @default(cuid())
  salesCustomerId   String       @map("sales_customer_id")
  salesCustomer     SalesCustomer @relation(fields: [salesCustomerId], references: [id], onDelete: Cascade)
  customerCode      String       @map("customer_code")
  year              Int
  month             Int
  amount            Decimal      @db.Decimal(12, 2)
  source            String       @default("DIRECT") // DIRECT | POS – POS is additive, does not overwrite DIRECT
  distributorName   String       @default("") @map("distributor_name") // Name CP (channel partner) for POS; "" for DIRECT

  @@unique([salesCustomerId, year, month, source, distributorName])
  @@index([salesCustomerId])
  @@index([year, month])
  @@index([source])
  @@index([distributorName])
  @@map("monthly_sales")
}

// ============================================================================
// QUOTE BANNERS (Admin-managed product advertisement images for PDF)
// ============================================================================

model QuoteBanner {
  id        String   @id @default(uuid())
  url       String   // R2 public URL (banners/<filename>)
  r2Key     String   @map("r2_key") // R2 object key for deletion
  label     String?  // Optional admin label / description
  active    Boolean  @default(true)
  order     Int      @default(0) // Display/selection order
  createdAt DateTime @default(now()) @map("created_at")

  @@index([active])
  @@map("quote_banners")
}

// ============================================================================
// APP SETTINGS (Global key-value store for admin-controlled settings)
// ============================================================================

model AppSetting {
  key       String   @id  // e.g. "genericThumbnailUrl", "genericThumbnailR2Key"
  value     String   @db.Text
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("app_settings")
}
